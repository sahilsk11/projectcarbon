<html>
    <head>
        <title>CO2 Values</title>

        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">

        <link href="css/organize.css" rel="stylesheet">
        <link href="css/simple-grid.css" rel="stylesheet">

        <link href="dashboard.png" rel="icon">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="js/XHRequest.js"></script>

        <script>

            function sendChartRequest(values) {
                XHRequest.createRequest({
                    success: parseChartData,
                    params: {
                        command: "getchart",
                        values: values
                    },
                    url: "response_handler.py"
                });
            }

            function getValueCount(override) {
                var url = new URL(window.location.href);
                var values = url.searchParams.get("values");
                if (values == null)
                {
                    values = 1000;
                } else {
                    document.getElementById("values").value = values;
                }
                sendChartRequest(values);
            }

            function validateInput(values) {
                if (isNaN(values)) {
                    return false;
                }
                return true;
            }

            function changeChart(override) {
                if (override != null) {
                    window.location = window.location.pathname;
                } else {
                    values = document.getElementById("values").value;
                    if (!validateInput(values)) {
                        changeChart(true);
                    } else {
                        var url = window.location.pathname;
                        window.location = url + '?values=' + values;
                    }
                }
            }

            function parseChartData(xhr, xhrConfig) {
                var co2Levels;
                var timeValues;
                var response = JSON.parse(xhr.responseText);
                timeValues = response[0];
                co2Levels = response[1];
                tempLevels = response[2];
                constructCharts(timeValues, co2Levels, tempLevels);
            }

            function constructCharts(timeValues, co2Levels, tempLevels) {
                var type;
                Chart.defaults.global.defaultFontFamily = "Source Code Pro";
                if (timeValues.length < 5) {
                    type = 'bar';
                } else {
                    type = 'line';
                }
                var co2GraphData = addLineGraph(type, timeValues, co2Levels, 'Carbon Dioxide', 'CO2 (ppm)', 1000);
                var ctx = document.getElementById('co2');
                var co2Graph = new Chart(ctx, co2GraphData);

                var temperatureGraphData = addLineGraph(type, timeValues, tempLevels, 'Temperature', 'Temperature (F)', 100);
                ctx = document.getElementById('temperature');
                var temperatureGraph = new Chart(ctx, temperatureGraphData);

                var co2AnalysisGraphData = generateDoughnut(false);
                ctx = document.getElementById('co2Analysis');
                var co2AnalysisGraph = new Chart(ctx, co2AnalysisGraphData);

                var tempAnalysisGraphData = generateDoughnut(false);
                ctx = document.getElementById('tempAnalysis');
                var tempAnalysisGraph = new Chart(ctx, tempAnalysisGraphData);
            }

            function addLineGraph(type, timeValues, yValues, title, yLabel, suggestedMax) {
                return {
                    type: type,
                    data: {
                        labels: timeValues,
                        datasets: [{
                            data: yValues,
                            borderColor: "rgba(0, 0, 0, 1)",
                            backgroundColor: "rgba(0, 0, 0, 0.3)",
                            pointRadius: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 20,
                                bottom: 20,
                            }
                        },
                        title: {
                            display: false,
                            text: title,
                            fontSize: 20,
                            position: 'top',
                        },
                        legend: {
                            display: false
                        },
                        scales: {
                            color: "white",
                            yAxes: [{
                                scaleLabel: {
                                    display: true,
                                    labelString: yLabel
                                },
                                ticks: {
                                    suggestedMax: suggestedMax,
                                    beginAtZero: true
                                }
                            }],
                            xAxis: [{
                                gridLines: {
                                    display: false
                                },
                                scaleLabel: {
                                    display: true,
                                }
                            }]
                        }
                    }
                }
            }

            function generateDoughnut(fullCircle) {
                var colors = ['rgba(0, 110, 0, 0.7)','rgba(0, 0, 0, 1)','rgba(170, 0, 0, 0.8)'];
                var type; //defines half circle or full
                if (fullCircle) {
                    type = 2;
                } else {
                    type = 1;
                }
                return {
                    type: 'pie',
                    data: {
                        datasets: [{
                            data: [100, 33, 33],
                            backgroundColor: colors
                        }],
                        labels: [
                            'Green',
                            'Black',
                            'Red'
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                bottom: 10
                            }
                        },
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Health',
                            fontSize: 20,
                            position: 'top',
                        },
                        cutoutPercentage: 55,
                        rotation:Math.PI * type,
                        circumference:Math.PI * type
                    }
                }
            }
        </script>
    </head>

    <body onload="getValueCount()" class="no-margin">

        <div class="side-nav">
            <img src="projectcarbon-white.png" class="side-logo">
            <p class="title-font side-text">project carbon</p>
        </div>

        <div class="page-content">

            <div class="floating-nav">

            </div>

            <div class="custom-container">
                <div class="row metric-box">
                    <h3 class="title-font metric-title">Carbon Dioxide</h3>
                    <div class="col-4 analysis-container">
                        <div class="pie-container">
                            <canvas id="co2Analysis" aria-label="Hello ARIA World" role="img"></canvas>
                        </div>
                    </div>
                    <div class="col-8 graph-container">
                        <canvas id="co2" aria-label="Hello ARIA World" role="img"></canvas>
                    </div>
                </div>
            </div>

            <div class="custom-container">
                <div class="row metric-box">
                    <h3 class="title-font metric-title">Temperature</h3>
                    <div class="col-4 analysis-container">
                        <div class="pie-container">
                            <canvas id="tempAnalysis" aria-label="Hello ARIA World" role="img"></canvas>
                        </div>
                    </div>
                    <div class="col-8 graph-container">
                        <canvas id="temperature" aria-label="Hello ARIA World" role="img"></canvas>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <label class="form-label">How many values to display?</label><br>
                <input id="values" autocomplete="off" class="value-input"><br><br>
                <button class="btn" onclick="changeChart()">Change</button>
                <button class="btn" onclick="changeChart(true)">Reset</button>
            </div>
        </div>
    </body>
</html>